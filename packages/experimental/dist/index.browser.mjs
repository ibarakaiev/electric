var z=Object.defineProperty,Q=Object.defineProperties;var W=Object.getOwnPropertyDescriptors;var O=Object.getOwnPropertySymbols;var X=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable;var L=t=>{throw TypeError(t)};var U=(t,e,s)=>e in t?z(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s,I=(t,e)=>{for(var s in e||(e={}))X.call(e,s)&&U(t,s,e[s]);if(O)for(var s of O(e))Y.call(e,s)&&U(t,s,e[s]);return t},K=(t,e)=>Q(t,W(e));var E=(t,e,s)=>e.has(t)||L("Cannot "+s);var a=(t,e,s)=>(E(t,e,"read from private field"),s?s.call(t):e.get(t)),l=(t,e,s)=>e.has(t)?L("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,s),S=(t,e,s,n)=>(E(t,e,"write to private field"),n?n.call(t,s):e.set(t,s),s),c=(t,e,s)=>(E(t,e,"access private method"),s);import{isChangeMessage as Z}from"@electric-sql/client";function te(t,e,s,n=6e4){return new Promise((i,h)=>{let o=t.subscribe(m=>{let _=m.filter(b=>Z(b)).find(b=>{let J=b.headers.operation;return e.includes(J)&&s(b)});if(_)return u(_)}),r=setTimeout(()=>{let m=`matchStream timed out after ${n}ms`;console.error(m),h(m)},n);function u(m){return clearTimeout(r),o(),i(m)}})}function ne(t,e){return s=>s.value[t]===e}function y(t){return BigInt(t.reduce((e,s)=>s>e?s:e))}function D(t){return BigInt(t.reduce((e,s)=>s<e?s:e))}function B(t,e){return t>e?1:t<e?-1:0}import{ShapeStream as P,isChangeMessage as F,isControlMessage as N}from"@electric-sql/client";var R,k,C,M,T,d,p,A,q,G,H,w,v=class{constructor(e){l(this,p);l(this,R);l(this,k,!1);l(this,C);l(this,M);l(this,T);l(this,d,new Map);let{start:s=!0,checkForUpdatesAfterMs:n=100,shapes:i}=e;this.checkForUpdatesAfterMs=n,S(this,R,Object.fromEntries(Object.entries(i).map(([h,o])=>[h,o instanceof P?o:new P(K(I({},o),{start:!1}))]))),S(this,M,Object.fromEntries(Object.entries(i).map(([h])=>[h,BigInt(-1)]))),S(this,T,Object.fromEntries(Object.entries(i).map(([h])=>[h,BigInt(-1)]))),s&&c(this,p,A).call(this)}async _publish(e){await Promise.all(Array.from(a(this,d).values()).map(async([s,n])=>{try{await s(e)}catch(i){queueMicrotask(()=>{throw i})}}))}get shapes(){return a(this,R)}subscribe(e,s){let n=Math.random();return a(this,d).set(n,[e,s]),a(this,k)||c(this,p,A).call(this),()=>{a(this,d).delete(n)}}unsubscribeAll(){a(this,d).clear()}lastSyncedAt(){let e=c(this,p,w).call(this);if(e.length!==0)return e.reduce((s,[n,i])=>{var h;return Math.min(s,(h=i.lastSyncedAt())!=null?h:1/0)},1/0)}lastSynced(){let e=this.lastSyncedAt();return e===void 0?1/0:Date.now()-e}isConnected(){return c(this,p,w).call(this).every(([e,s])=>s.isConnected())}isLoading(){return c(this,p,w).call(this).some(([e,s])=>s.isLoading())}get isUpToDate(){return c(this,p,w).call(this).every(([e,s])=>s.isUpToDate)}};R=new WeakMap,k=new WeakMap,C=new WeakMap,M=new WeakMap,T=new WeakMap,d=new WeakMap,p=new WeakSet,A=function(){if(a(this,k))throw new Error("Cannot start multi-shape stream twice");for(let[e,s]of c(this,p,w).call(this)){if(s.hasStarted())throw new Error(`Shape ${e} already started`);s.subscribe(async n=>{let i=n.filter(N).map(({headers:r})=>typeof r.global_last_seen_lsn=="string"?BigInt(r.global_last_seen_lsn):BigInt(0));if(i.length>0){let r=y(i),u=a(this,T)[e];r>u&&(a(this,T)[e]=r)}let h=n.filter(F).map(({headers:r})=>typeof r.lsn=="string"?BigInt(r.lsn):BigInt(0));if(h.length>0){let r=y(h),u=a(this,M)[e];r>u&&(a(this,M)[e]=r),c(this,p,q).call(this)}let o=n.map(r=>K(I({},r),{shape:e}));await this._publish(o)},n=>c(this,p,H).call(this,n))}S(this,k,!0)},q=function(){var e;(e=a(this,C))!=null||S(this,C,setTimeout(()=>{c(this,p,G).call(this),S(this,C,void 0)},this.checkForUpdatesAfterMs))},G=async function(){let e=y(Object.values(a(this,M))),s=c(this,p,w).call(this).filter(([n])=>a(this,T)[n]<e).map(([n,i])=>i.forceDisconnectAndRefresh());await Promise.all(s)},H=function(e){a(this,d).forEach(([s,n])=>{n==null||n(e)})},w=function(){return Object.entries(a(this,R))};var g,f,x,V,$,j=class extends v{constructor(s){super(s);l(this,x);l(this,g,new Map);l(this,f);S(this,f,Object.fromEntries(Object.entries(s.shapes).map(([n])=>[n,BigInt(-1)])))}async _publish(s){c(this,x,$).call(this,s);let n=c(this,x,V).call(this),i=[...a(this,g).keys()].filter(o=>o<=n),h=i.sort((o,r)=>B(o,r)).map(o=>{var r;return(r=a(this,g).get(o))==null?void 0:r.sort((u,m)=>{let{headers:_}=u,{headers:b}=m;return typeof _.op_position!="number"||typeof b.op_position!="number"?0:_.op_position-b.op_position})}).filter(o=>o!==void 0).flat();i.forEach(o=>{a(this,g).delete(o)}),h.length>0&&await super._publish(h)}};g=new WeakMap,f=new WeakMap,x=new WeakSet,V=function(){return D(Object.values(a(this,f)))},$=function(s){let n=this.isUpToDate;s.forEach(i=>{var r;let{shape:h,headers:o}=i;if(F(i)){let u=typeof o.lsn=="string"?BigInt(o.lsn):BigInt(0);a(this,g).has(u)||a(this,g).set(u,[]),(r=a(this,g).get(u))==null||r.push(i),n&&typeof o.last=="boolean"&&o.last===!0&&(a(this,f)[h]=y([a(this,f)[h],u]))}else if(N(i)&&o.control==="up-to-date"){if(typeof o.global_last_seen_lsn!="string")throw new Error("global_last_seen_lsn is not a number");a(this,f)[h]=y([a(this,f)[h],BigInt(o.global_last_seen_lsn)])}})};export{v as MultiShapeStream,j as TransactionalMultiShapeStream,ne as matchBy,te as matchStream};
//# sourceMappingURL=index.browser.mjs.map